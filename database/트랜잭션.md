## 트랜잭션

- **하나의 작업을 수행하기 위해 필요한 데이터베이스의 연산들을 모아놓은 것**으로, 데이터베이스에서 논리적인 작업의 단위이며 장애가 발생했을 때 데이터를 복구하는 작업의 단위이다.

### 트랜잭션의 특징(ACID)

- Atomicity(원자성)
  - 트랜잭션을 구성하는 연산들이 모두 정상적으로 실행되거나 하나도 실행되지 않아야 한다는 **all-or-nothing** 방식을 의미한다.
- Consistency(일관성)
  - 트랜잭션이 성공적으로 수행된 후에도 데이터베이스가 일관성 있는 상태를 유지해야 함을 의미한다.
  - 예시) 계좌 이체 진행 시 진행 전의 돈의 합과 진행 후의 돈의 합이 같아야 한다.
- Isolation(격리성)
  - 현재 수행 중인 트랜잭션이 완료될 때까지 트랜잭션이 생성한 중간 연산 결과에 다른 트랜잭션들이 접근할 수 없음을 의미한다.
  - 예시) A 가 B 에게 500원을 보내고 있는데 다른 트랜잭션이 끼어들어 B 에게 돈을 보낼 수  없다. A 가 먼저 B 에 대한 트랜잭션을 완료한 후에 시행이 된다.
- Durability(지속성)
  - 트랜잭션이 성공적으로 완료된 후 데이터베이스에 반영한 수행 결과는 어떠한 경우에도 손실되지 않고 영구적이어야 함을 의미한다.

### 트랜잭션의 연산

- commit 연산
  - 트랜잭션이 성공적으로 수행되었음을 선언(작업 완료)
  - commit 연산이 실행된 후에야 트랜잭션의 수행 결과가 데이터베이스에 반영되어 데이터베이스가 일관된 상태를 지속적으로 유지한다.
- rollback 연산
  - 트랜잭션이 수행을 실패했음을 선언(작업 취소)
  - rollback 연산이 실행되면 지금까지 실행한 연산의 결과가 취소되고, 트랜잭션이 수행되기 전의 상태로 다시 돌아간다.

### 트랜잭션 격리(Isolation Level) 수준

- 트랜잭션에서 일관성이 없는 데이터를 허용하도록 하는 수준 
- read uncommitted (레벨0)
  - SELECT 문장이 수행되는 동안 해당 데이터에 Shared Lock 이 걸리지 않는 레벨
  - **트랜잭션에 처리중인 혹은 아직 커밋되지 않은 데이터를 다른 트랜잭션이 읽는 것을 허용한다.**
  - 따라서, 어떤 사용자가 A 라는 데이터를 B 라는 데이터로 변경하는 동안 다른 사용자는 아직 완료되지 않은 트랜잭션이지만 변경된 데이터 B 를 읽을 수 있다. 
  - 데이터의 일관성을 유지할 수 없다.
- read committed (레벨1)
  - SELECT 문장이 수행되는 동안 해당 데이터에 Shared Lock 이 걸리는 레벨
  - **트랜잭션이 수행되는 동안 다른 트랜잭션이 접근할 수 없이 대기하게 된다.**
  - commit 이 이루어진 트랜잭션만 조회할 수 있다.
  - 따라서, 어떤 사용자가 A 라는 데이터를 B 라는 데이터로 변경하는 동안 다른 사용자는 해당 데이터에 접근 할 수 없다.
- repeatable read (레벨2)
  - 트랜잭션이 완료될 때까지 SELECT 문장이 사용하는 모든 데이터에 Shared Lock 이 걸리는 레벨
  - **트랜잭션이 범위 내에서 조회한 데이터의 내용이 항상 동일함을 보장한다.**
  - 따라서, 다른 사용자는 그 영역에 해당되는 데이터에 대한 수정이 불가능하다.
- serializable (레벨3)
  - 트랜잭션이 완료될 때까지 SELECT 문장이 사용하는 모든 데이터에 Shared Lock 이 걸리는 레벨
  - 완벽한 읽기 일관성 모드를 제공한다. **성능에 매우 떨어진다.**
  - 따라서, 다른 사용자는 그 영역에 해당되는 데이터에 대한 수정 및 입력이 불가능하다.
- 낮은 단계의 Isolation Level 이용시 발생하는 현상

| Isolation Level  | dirty read | non-repeatable read | phantom read |
|:-----------------|:-----------|:--------------------|:-------------|
| read uncommitted | O          | O                   | O            |
| read committed   | -          | O                   | O            |
| repeatable read  | -          | -                   | O            |
| serializable     | -          | -                   | -            |
- dirty read
  - 커밋되지 않은 수정 중인 데이터를 다른 트랜잭션에서 읽을 수 있도록 허용할 때 발생하는 현상
  - 어떤 트랜잭션에서 아직 실행이 끝나지 않은 다른 트랜잭션에 의한 변경 사항을 보게 되는 경우
- non-repeatable read
  - 한 트랜잭션에서 같은 쿼리를 두 번 수행할 때 그 사이에 다른 트랜잭션이 값을 수정 또는 삭제함으로써 두 쿼리의 결과가 상이하게 나타나는 비 일관성 현상
- phantom read
  - 한 트랜잭션 안에서 일정 범위의 레코드를 두 번 이상 읽을 때, 첫 번째 쿼리에서 없던 레코드가 두 번째 쿼리에서 나타나는 현상
  - 이는 트랜잭션 도중 새로운 레코드가 삽입되는 것을 허용하기 때문에 나타난다.